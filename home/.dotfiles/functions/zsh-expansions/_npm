#compdef npm

# Completion Script taken from
# https://askql.wordpress.com/2011/01/11/zsh-writing-own-completion/
_npm() {
  local curcontext="$curcontext" state line
  typeset -A opt_args

  _arguments \
    '1: :->methods'

  case $state in
    methods)
      _arguments '1:Commands:(run install)' \
      ;;
    *)
      case $words[2] in
        run)
          PACKAGE_JSON="package.json"
          GIT_ROOT="$(git rev-parse --show-toplevel)"
          GIT_ROOT_PACKAGE_JSON="$GIT_ROOT/$PACKAGE_JSON"

          # When no package.json is in the current directory to read the scripts
          # from, try to load the package.json in the git_root
          # When this doesnt exists, exit
          if [[ ! -f "$PACKAGE_JSON" ]]; then
            if [[ -f "$GIT_ROOT_PACKAGE_JSON" ]]; then
              PACKAGE_JSON="$GIT_ROOT_PACKAGE_JSON"
            else
              return 0
            fi
          fi

          scripts=$(cat "$PACKAGE_JSON" | jq ".scripts | keys[]" | sed 's/["]//g')

          while read -r line; do
            compadd "$@" $line
          done <<< "$scripts"
          ;;
        *)
          _files
      esac
  esac
}

_npm "$@"
